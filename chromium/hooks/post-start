#!/bin/bash
# Register Playwright MCP server in Nexus after Chromium starts
# This enables AI browser control via LivOS

# URL-decode helper (converts %XX sequences to characters)
urldecode() {
  printf '%b' "${1//%/\\x}"
}

# Extract Redis password from URL (may be URL-encoded)
REDIS_PASSWORD_RAW=$(echo "${REDIS_URL:-}" | sed -n 's|redis://:\([^@]*\)@.*|\1|p')
if [ -z "$REDIS_PASSWORD_RAW" ]; then
  # Try reading from .env
  if [ -f "/opt/livos/.env" ]; then
    REDIS_PASSWORD_RAW=$(grep REDIS_URL /opt/livos/.env | sed -n 's|.*redis://:\([^@]*\)@.*|\1|p')
  fi
fi
REDIS_PASSWORD=$(urldecode "$REDIS_PASSWORD_RAW")

if [ -z "$REDIS_PASSWORD" ]; then
  echo "[chromium-mcp] No Redis password found, skipping MCP registration"
  exit 0
fi

REDIS_CMD="redis-cli -a $REDIS_PASSWORD --no-auth-warning"

# Wait for CDP to be ready (avoid early MCP connection failures)
sleep 3

# Build the MCP config JSON
CONTAINER_NAME="chromium_server_1"
MCP_CONFIG=$(cat <<'MCPJSON'
{
  "mcpServers": {
    "browser": {
      "name": "browser",
      "transport": "stdio",
      "command": "docker",
      "args": ["exec", "-i", "chromium_server_1", "npx", "-y", "@playwright/mcp@latest", "--cdp-endpoint", "http://localhost:9222"],
      "enabled": true,
      "description": "Browser automation via Playwright CDP"
    }
  }
}
MCPJSON
)

# Get existing config and merge
EXISTING=$($REDIS_CMD GET nexus:mcp:config 2>/dev/null)

if [ -z "$EXISTING" ] || [ "$EXISTING" = "(nil)" ]; then
  # No existing config, set ours
  $REDIS_CMD SET nexus:mcp:config "$MCP_CONFIG" >/dev/null 2>&1
else
  # Merge browser entry into existing config
  MERGED=$(echo "$EXISTING" | jq --argjson new "$MCP_CONFIG" '.mcpServers.browser = $new.mcpServers.browser')
  $REDIS_CMD SET nexus:mcp:config "$MERGED" >/dev/null 2>&1
fi

# Notify Nexus to reload MCP config
$REDIS_CMD PUBLISH nexus:config:updated mcp_config >/dev/null 2>&1

echo "[chromium-mcp] Playwright MCP server registered"
